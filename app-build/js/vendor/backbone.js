(function(e,r){"undefined"!=typeof exports?r(e,exports,require("underscore")):"function"==typeof define&&define.amd?define(["underscore","jquery","exports"],function(o,i,T){e.Backbone=r(e,T,o,i)}):e.Backbone=r(e,{},e._,e.jQuery||e.Zepto||e.ender)})(this,function(e,r,o,i){var T=e.Backbone,v=[],u=v.push,b=v.slice,C=v.splice;r.VERSION="0.9.10";r.$=i;r.noConflict=function(){e.Backbone=T;return this};r.emulateHTTP=!1;r.emulateJSON=!1;var z=/\s+/,n=function(e,r,o,i){if(!o)return!0;if("object"==typeof o)for(var T in o)e[r].apply(e,[T,o[T]].concat(i));else{if(!z.test(o))return!0;o=o.split(z);T=0;for(var v=o.length;v>T;T++)e[r].apply(e,[o[T]].concat(i))}},l=function(e,r){var o,i=-1,T=e.length;switch(r.length){case 0:for(;T>++i;)(o=e[i]).callback.call(o.ctx);break;case 1:for(;T>++i;)(o=e[i]).callback.call(o.ctx,r[0]);break;case 2:for(;T>++i;)(o=e[i]).callback.call(o.ctx,r[0],r[1]);break;case 3:for(;T>++i;)(o=e[i]).callback.call(o.ctx,r[0],r[1],r[2]);break;default:for(;T>++i;)(o=e[i]).callback.apply(o.ctx,r)}},i=r.Events={on:function(e,r,o){if(!n(this,"on",e,[r,o])||!r)return this;this._events||(this._events={});(this._events[e]||(this._events[e]=[])).push({callback:r,context:o,ctx:o||this});return this},once:function(e,r,i){if(!n(this,"once",e,[r,i])||!r)return this;var T=this,v=o.once(function(){T.off(e,v);r.apply(this,arguments)});v._callback=r;this.on(e,v,i);return this},off:function(e,r,i){var T,v,u,b,C,z,l,t;if(!this._events||!n(this,"off",e,[r,i]))return this;if(!e&&!r&&!i)return this._events={},this;b=e?[e]:o.keys(this._events);for(C=0,z=b.length;z>C;C++)if(e=b[C],T=this._events[e]){u=[];if(r||i)for(l=0,t=T.length;t>l;l++)v=T[l],(r&&r!==v.callback&&r!==v.callback._callback||i&&i!==v.context)&&u.push(v);this._events[e]=u}return this},trigger:function(e){if(!this._events)return this;var r=b.call(arguments,1);if(!n(this,"trigger",e,r))return this;var o=this._events[e],i=this._events.all;o&&l(o,r);i&&l(i,arguments);return this},listenTo:function(e,r,i){var T=this._listeners||(this._listeners={}),v=e._listenerId||(e._listenerId=o.uniqueId("l"));T[v]=e;e.on(r,"object"==typeof r?this:i,this);return this},stopListening:function(e,r,o){var i=this._listeners;if(i){if(e)e.off(r,"object"==typeof r?this:o,this),!r&&!o&&delete i[e._listenerId];else{"object"==typeof r&&(o=this);for(var T in i)i[T].off(r,o,this);this._listeners={}}return this}}};i.bind=i.on;i.unbind=i.off;o.extend(r,i);var t=r.Model=function(e,r){var i,T=e||{};this.cid=o.uniqueId("c");this.attributes={};r&&r.collection&&(this.collection=r.collection);r&&r.parse&&(T=this.parse(T,r)||{});(i=o.result(this,"defaults"))&&(T=o.defaults({},T,i));this.set(T,r);this.changed={};this.initialize.apply(this,arguments)};o.extend(t.prototype,i,{changed:null,idAttribute:"id",initialize:function(){},toJSON:function(){return o.clone(this.attributes)},sync:function(){return r.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return o.escape(this.get(e))},has:function(e){return null!=this.get(e)},set:function(e,r,i){var T,v,u,b,C,z,n;if(null==e)return this;"object"==typeof e?(v=e,i=r):(v={})[e]=r;i||(i={});if(!this._validate(v,i))return!1;u=i.unset;b=i.silent;e=[];C=this._changing;this._changing=!0;C||(this._previousAttributes=o.clone(this.attributes),this.changed={});n=this.attributes;z=this._previousAttributes;this.idAttribute in v&&(this.id=v[this.idAttribute]);for(T in v)r=v[T],o.isEqual(n[T],r)||e.push(T),o.isEqual(z[T],r)?delete this.changed[T]:this.changed[T]=r,u?delete n[T]:n[T]=r;if(!b){e.length&&(this._pending=!0);r=0;for(T=e.length;T>r;r++)this.trigger("change:"+e[r],this,n[e[r]],i)}if(C)return this;if(!b)for(;this._pending;)this._pending=!1,this.trigger("change",this,i);this._changing=this._pending=!1;return this},unset:function(e,r){return this.set(e,void 0,o.extend({},r,{unset:!0}))},clear:function(e){var r,i={};for(r in this.attributes)i[r]=void 0;return this.set(i,o.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!o.isEmpty(this.changed):o.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?o.clone(this.changed):!1;var r,i,T=!1,v=this._changing?this._previousAttributes:this.attributes;for(i in e)o.isEqual(v[i],r=e[i])||((T||(T={}))[i]=r);return T},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return o.clone(this._previousAttributes)},fetch:function(e){e=e?o.clone(e):{};void 0===e.parse&&(e.parse=!0);var r=e.success;e.success=function(e,o,i){if(!e.set(e.parse(o,i),i))return!1;r&&r(e,o,i);return void 0};return this.sync("read",this,e)},save:function(e,r,i){var T,v,u=this.attributes;null==e||"object"==typeof e?(T=e,i=r):(T={})[e]=r;if(!(!T||i&&i.wait||this.set(T,i)))return!1;i=o.extend({validate:!0},i);if(!this._validate(T,i))return!1;T&&i.wait&&(this.attributes=o.extend({},u,T));void 0===i.parse&&(i.parse=!0);v=i.success;i.success=function(e,r,i){e.attributes=u;var b=e.parse(r,i);i.wait&&(b=o.extend(T||{},b));if(o.isObject(b)&&!e.set(b,i))return!1;v&&v(e,r,i);return void 0};e=this.isNew()?"create":i.patch?"patch":"update";"patch"===e&&(i.attrs=T);e=this.sync(e,this,i);T&&i.wait&&(this.attributes=u);return e},destroy:function(e){var e=e?o.clone(e):{},r=this,i=e.success,T=function(){r.trigger("destroy",r,r.collection,e)};e.success=function(e,r,o){(o.wait||e.isNew())&&T();i&&i(e,r,o)};if(this.isNew())return e.success(this,null,e),!1;var v=this.sync("delete",this,e);e.wait||T();return v},url:function(){var e=o.result(this,"urlRoot")||o.result(this.collection,"url")||k();return this.isNew()?e:e+("/"===e.charAt(e.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(e){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},isValid:function(e){return!this.validate||!this.validate(this.attributes,e)},_validate:function(e,r){if(!r.validate||!this.validate)return!0;var e=o.extend({},this.attributes,e),i=this.validationError=this.validate(e,r)||null;if(!i)return!0;this.trigger("invalid",this,i,r||{});return!1}});var s=r.Collection=function(e,r){r||(r={});r.model&&(this.model=r.model);void 0!==r.comparator&&(this.comparator=r.comparator);this.models=[];this._reset();this.initialize.apply(this,arguments);e&&this.reset(e,o.extend({silent:!0},r))};o.extend(s.prototype,i,{model:t,initialize:function(){},toJSON:function(e){return this.map(function(r){return r.toJSON(e)})},sync:function(){return r.sync.apply(this,arguments)},add:function(e,r){e=o.isArray(e)?e.slice():[e];r||(r={});var i,T,v,b,z,n,l,t,s,a;l=[];t=r.at;s=this.comparator&&null==t&&0!=r.sort;a=o.isString(this.comparator)?this.comparator:null;for(i=0,T=e.length;T>i;i++)(v=this._prepareModel(b=e[i],r))?(z=this.get(v))?r.merge&&(z.set(b===v?v.attributes:b,r),s&&!n&&z.hasChanged(a)&&(n=!0)):(l.push(v),v.on("all",this._onModelEvent,this),this._byId[v.cid]=v,null!=v.id&&(this._byId[v.id]=v)):this.trigger("invalid",this,b,r);l.length&&(s&&(n=!0),this.length+=l.length,null!=t?C.apply(this.models,[t,0].concat(l)):u.apply(this.models,l));n&&this.sort({silent:!0});if(r.silent)return this;for(i=0,T=l.length;T>i;i++)(v=l[i]).trigger("add",v,this,r);n&&this.trigger("sort",this,r);return this},remove:function(e,r){e=o.isArray(e)?e.slice():[e];r||(r={});var i,T,v,u;for(i=0,T=e.length;T>i;i++)if(u=this.get(e[i])){delete this._byId[u.id];delete this._byId[u.cid];v=this.indexOf(u);this.models.splice(v,1);this.length--;r.silent||(r.index=v,u.trigger("remove",u,this,r));this._removeReference(u)}return this},push:function(e,r){e=this._prepareModel(e,r);this.add(e,o.extend({at:this.length},r));return e},pop:function(e){var r=this.at(this.length-1);this.remove(r,e);return r},unshift:function(e,r){e=this._prepareModel(e,r);this.add(e,o.extend({at:0},r));return e},shift:function(e){var r=this.at(0);this.remove(r,e);return r},slice:function(e,r){return this.models.slice(e,r)},get:function(e){return null!=e?(this._idAttr||(this._idAttr=this.model.prototype.idAttribute),this._byId[e.id||e.cid||e[this._idAttr]||e]):void 0},at:function(e){return this.models[e]},where:function(e){return o.isEmpty(e)?[]:this.filter(function(r){for(var o in e)if(e[o]!==r.get(o))return!1;return!0})},sort:function(e){if(!this.comparator)throw Error("Cannot sort a set without a comparator");e||(e={});o.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(o.bind(this.comparator,this));e.silent||this.trigger("sort",this,e);return this},pluck:function(e){return o.invoke(this.models,"get",e)},update:function(e,r){r=o.extend({add:!0,merge:!0,remove:!0},r);r.parse&&(e=this.parse(e,r));var i,T,v,u,b=[],C=[],z={};o.isArray(e)||(e=e?[e]:[]);if(r.add&&!r.remove)return this.add(e,r);for(T=0,v=e.length;v>T;T++)i=e[T],u=this.get(i),r.remove&&u&&(z[u.cid]=!0),(r.add&&!u||r.merge&&u)&&b.push(i);if(r.remove)for(T=0,v=this.models.length;v>T;T++)i=this.models[T],z[i.cid]||C.push(i);C.length&&this.remove(C,r);b.length&&this.add(b,r);return this},reset:function(e,r){r||(r={});r.parse&&(e=this.parse(e,r));for(var i=0,T=this.models.length;T>i;i++)this._removeReference(this.models[i]);r.previousModels=this.models.slice();this._reset();e&&this.add(e,o.extend({silent:!0},r));r.silent||this.trigger("reset",this,r);return this},fetch:function(e){e=e?o.clone(e):{};void 0===e.parse&&(e.parse=!0);var r=e.success;e.success=function(e,o,i){e[i.update?"update":"reset"](o,i);r&&r(e,o,i)};return this.sync("read",this,e)},create:function(e,r){r=r?o.clone(r):{};if(!(e=this._prepareModel(e,r)))return!1;r.wait||this.add(e,r);var i=this,T=r.success;r.success=function(e,r,o){o.wait&&i.add(e,o);T&&T(e,r,o)};e.save(null,r);return e},parse:function(e){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models.length=0;this._byId={}},_prepareModel:function(e,r){if(e instanceof t){e.collection||(e.collection=this);return e}r||(r={});r.collection=this;var o=new this.model(e,r);return o._validate(e,r)?o:!1},_removeReference:function(e){this===e.collection&&delete e.collection;e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,r,o,i){("add"===e||"remove"===e)&&o!==this||("destroy"===e&&this.remove(r,i),r&&e==="change:"+r.idAttribute&&(delete this._byId[r.previous(r.idAttribute)],null!=r.id&&(this._byId[r.id]=r)),this.trigger.apply(this,arguments))},sortedIndex:function(e,r,i){r||(r=this.comparator);var T=o.isFunction(r)?r:function(e){return e.get(r)};return o.sortedIndex(this.models,e,T,i)}});o.each("forEach,each,map,collect,reduce,foldl,inject,reduceRight,foldr,find,detect,filter,select,reject,every,all,some,any,include,contains,invoke,max,min,toArray,size,first,head,take,initial,rest,tail,drop,last,without,indexOf,shuffle,lastIndexOf,isEmpty,chain".split(","),function(e){s.prototype[e]=function(){var r=b.call(arguments);r.unshift(this.models);return o[e].apply(o,r)}});o.each(["groupBy","countBy","sortBy"],function(e){s.prototype[e]=function(r,i){var T=o.isFunction(r)?r:function(e){return e.get(r)};return o[e](this.models,T,i)}});var v=r.Router=function(e){e||(e={});e.routes&&(this.routes=e.routes);this._bindRoutes();this.initialize.apply(this,arguments)},a=/\((.*?)\)/g,h=/(\(\?)?:\w+/g,c=/\*\w+/g,m=/[\-{}\[\]+?.,\\\^$|#\s]/g;o.extend(v.prototype,i,{initialize:function(){},route:function(e,i,T){o.isRegExp(e)||(e=this._routeToRegExp(e));T||(T=this[i]);r.history.route(e,o.bind(function(o){o=this._extractParameters(e,o);T&&T.apply(this,o);this.trigger.apply(this,["route:"+i].concat(o));this.trigger("route",i,o);r.history.trigger("route",this,i,o)},this));return this},navigate:function(e,o){r.history.navigate(e,o);return this},_bindRoutes:function(){if(this.routes)for(var e,r=o.keys(this.routes);null!=(e=r.pop());)this.route(e,this.routes[e])},_routeToRegExp:function(e){e=e.replace(m,"\\$&").replace(a,"(?:$1)?").replace(h,function(e,r){return r?e:"([^/]+)"}).replace(c,"(.*?)");return RegExp("^"+e+"$")},_extractParameters:function(e,r){return e.exec(r).slice(1)}});var d=r.History=function(){this.handlers=[];o.bindAll(this,"checkUrl");"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},p=/^[#\/]|\s+$/g,f=/^\/+|\/+$/g,g=/msie [\w.]+/,P=/\/$/;d.started=!1;o.extend(d.prototype,i,{interval:50,getHash:function(e){return(e=(e||this).location.href.match(/#(.*)$/))?e[1]:""},getFragment:function(e,r){if(null==e)if(this._hasPushState||!this._wantsHashChange||r){var e=this.location.pathname,o=this.root.replace(P,"");e.indexOf(o)||(e=e.substr(o.length))}else e=this.getHash();return e.replace(p,"")},start:function(e){if(d.started)throw Error("Backbone.history has already been started");d.started=!0;this.options=o.extend({},{root:"/"},this.options,e);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==!1;this._wantsPushState=!!this.options.pushState;this._hasPushState=!(!this.options.pushState||!this.history||!this.history.pushState);var e=this.getFragment(),i=document.documentMode,i=g.exec(navigator.userAgent.toLowerCase())&&(!i||7>=i);this.root=("/"+this.root+"/").replace(f,"/");i&&this._wantsHashChange&&(this.iframe=r.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e));this._hasPushState?r.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!i?r.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval));this.fragment=e;e=this.location;i=e.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!i)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&i&&e.hash&&(this.fragment=this.getHash().replace(p,""),this.history.replaceState({},document.title,this.root+this.fragment+e.search));return this.options.silent?void 0:this.loadUrl()},stop:function(){r.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);d.started=!1},route:function(e,r){this.handlers.unshift({route:e,callback:r})},checkUrl:function(){var e=this.getFragment();e===this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe)));if(e===this.fragment)return!1;this.iframe&&this.navigate(e);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var r=this.fragment=this.getFragment(e);return o.any(this.handlers,function(e){return e.route.test(r)?(e.callback(r),!0):void 0})},navigate:function(e,r){if(!d.started)return!1;r&&r!==!0||(r={trigger:r});e=this.getFragment(e||"");if(this.fragment!==e){this.fragment=e;var o=this.root+e;if(this._hasPushState)this.history[r.replace?"replaceState":"pushState"]({},document.title,o);else{if(!this._wantsHashChange)return this.location.assign(o);this._updateHash(this.location,e,r.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(r.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,r.replace))}r.trigger&&this.loadUrl(e)}},_updateHash:function(e,r,o){o?(o=e.href.replace(/(javascript:|#).*$/,""),e.replace(o+"#"+r)):e.hash="#"+r}});r.history=new d;var _=r.View=function(e){this.cid=o.uniqueId("view");this._configure(e||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()},y=/^(\S+)\s*(.*)$/,w="model,collection,el,id,attributes,className,tagName,events".split(",");o.extend(_.prototype,i,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(e,o){this.$el&&this.undelegateEvents();this.$el=e instanceof r.$?e:r.$(e);this.el=this.$el[0];o!==!1&&this.delegateEvents();return this},delegateEvents:function(e){if(e||(e=o.result(this,"events"))){this.undelegateEvents();for(var r in e){var i=e[r];o.isFunction(i)||(i=this[e[r]]);if(!i)throw Error('Method "'+e[r]+'" does not exist');var T=r.match(y),v=T[1],T=T[2],i=o.bind(i,this);v+=".delegateEvents"+this.cid;""===T?this.$el.on(v,i):this.$el.on(v,T,i)}}},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=o.extend({},o.result(this,"options"),e));o.extend(this,o.pick(e,w));this.options=e},_ensureElement:function(){if(this.el)this.setElement(o.result(this,"el"),!1);else{var e=o.extend({},o.result(this,"attributes"));this.id&&(e.id=o.result(this,"id"));this.className&&(e["class"]=o.result(this,"className"));this.setElement(r.$("<"+o.result(this,"tagName")+">").attr(e),!1)}}});var x={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};r.sync=function(e,i,T){var v=x[e];o.defaults(T||(T={}),{emulateHTTP:r.emulateHTTP,emulateJSON:r.emulateJSON});var u={type:v,dataType:"json"};T.url||(u.url=o.result(i,"url")||k());null!=T.data||!i||"create"!==e&&"update"!==e&&"patch"!==e||(u.contentType="application/json",u.data=JSON.stringify(T.attrs||i.toJSON(T)));T.emulateJSON&&(u.contentType="application/x-www-form-urlencoded",u.data=u.data?{model:u.data}:{});if(T.emulateHTTP&&("PUT"===v||"DELETE"===v||"PATCH"===v)){u.type="POST";T.emulateJSON&&(u.data._method=v);var b=T.beforeSend;T.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",v);return b?b.apply(this,arguments):void 0}}"GET"===u.type||T.emulateJSON||(u.processData=!1);var C=T.success;T.success=function(e){C&&C(i,e,T);i.trigger("sync",i,e,T)};var z=T.error;T.error=function(e){z&&z(i,e,T);i.trigger("error",i,e,T)};e=T.xhr=r.ajax(o.extend(u,T));i.trigger("request",i,e,T);return e};r.ajax=function(){return r.$.ajax.apply(r.$,arguments)};t.extend=s.extend=v.extend=_.extend=d.extend=function(e,r){var i,T=this;i=e&&o.has(e,"constructor")?e.constructor:function(){return T.apply(this,arguments)};o.extend(i,T,r);var v=function(){this.constructor=i};v.prototype=T.prototype;i.prototype=new v;e&&o.extend(i.prototype,e);i.__super__=T.prototype;return i};var k=function(){throw Error('A "url" property or function must be specified')};return r});